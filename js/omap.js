var omap,marker_user,markers,default_lat=25.0315785,default_lng=121.4427123,mask_inventory=[],show_adult_inventory=!1,show_child_inventory=!1,dont_show_null_inventory=!0,dont_show_no_open=!0,mask_inventory_last_update="",show_inventory_hight=!0,show_inventory_medium=!0,show_inventory_low=!0,show_inventory_zero=!1;$(function(){getUserGEOInfo(!1)});
var geoSuccess=function(c){c=c.coords;default_lat=c.latitude;default_lng=c.longitude;void 0!==marker_user?marker_user.setLatLng([default_lat,default_lng]):(void 0===omap&&createMap(),marker_user=L.marker([default_lat,default_lng]).bindTooltip("\u6211",{direction:"top",permanent:!0}).openTooltip(),marker_user.addTo(omap));omap.setView([default_lat,default_lng],16)},geoError=function(c){void 0===omap&&createMap()},getUserGEOInfo=function(c){!0===c&&gtag("event","click",{event_category:"\u5730\u5716\u5de5\u5177",
event_label:"\u4f7f\u7528\u8005\u5b9a\u4f4d"});navigator.geolocation?navigator.geolocation.getCurrentPosition(geoSuccess,geoError,{enableHighAccuracy:!0,timeout:5E3,maximumAge:0}):void 0===omap&&createMap()},onMapLoad=function(){showTopMessage()},createMap=function(){omap=L.map("omap",{zoomControl:!1});omap.on("load",onMapLoad);omap.setView([default_lat,default_lng],16);L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://maps.nlsc.gov.tw/">\u570b\u571f\u6e2c\u7e6a\u4e2d\u5fc3</a>',
maxZoom:20,minZoom:9}).addTo(omap);L.control.zoom({position:"bottomright"}).addTo(omap);createCustomButton();markers=L.markerClusterGroup({chunkedLoading:!0,disableClusteringAtZoom:16,elementsPlacementStrategy:"original-locations"});loadMaskInventory(!1)},createCustomButton=function(){L.control.custom({position:"bottomright",content:'<button id="back_btn" type="button" class="btn btn-default" title="\u56de\u5230\u6211\u7684\u4f4d\u7f6e">    <i class="fas fa-crosshairs"></i></button><button id="info_btn" type="button" class="btn btn-info" title="\u516c\u544a">    <i class="fas fa-info"></i></button><a target="_blank" id="buy_mask" href="https://emask.taiwan.gov.tw/" class="btn btn-default" title="\u9810\u8cfc\u53e3\u7f69" onclick="buy_mask();">    <i class="fas fa-shopping-cart"></i></a><button id="reload_btn" type="button" class="btn btn-primary" title="\u91cd\u65b0\u6574\u7406">    <i class="fas fa-sync"></i></button><button id="history_btn" type="button" class="btn btn-success" title="\u66f4\u65b0\u7d00\u9304">    <i class="fas fa-list-alt"></i></button><button id="twcdc_fb_btn" type="button" class="btn btn-warning" title="\u75be\u7ba1\u7f72">    <i class="fas fa-clinic-medical"></i></button>',
classes:"btn-group-vertical bt-group-sm",style:{margin:"10px",padding:"0px 0 0 0",cursor:"pointer"}}).addTo(omap);$("#back_btn").click(function(c){getUserGEOInfo(!0)});$("#exclamation_btn").click(function(c){showWarningMessage()});$("#info_btn").click(function(c){showInfoMessage()});$("#reload_btn").click(function(c){showUpdateProcess()});$("#history_btn").click(function(c){showVersionHistory()});$("#twcdc_fb_btn").click(function(c){showTwcdcFB()})},reloadStrongholdData=function(c){$("#reload_btn").attr("disabled",
!0);$("#reload_btn i").removeClass();$("#reload_btn i").addClass("fas fa-sync fa-spin fa-fw");$("#mask_inventory_last_update").html('<span id="process_status" class="fa fa-spinner fa-spin"></span>');loadMaskInventory(c)},checkTimerOpen=function(c,e,b,a){c=(new Date).getHours();return 13<=c&&"X"==e&&"X"==b?!1:18<=c&&"X"==b?!1:a},strongholdInfo=function(c){var e=c.tel,b=c.addr,a=mask_inventory[c.id];e="<h3>"+c.name+"</h3>\u96fb\u8a71\uff1a<a href='tel:+886"+(e+"'><i class='fas fa-phone-alt'></i> "+
e+"</a><br />");e+="\u5730\u5740\uff1a<a target='_blank' href='https://www.google.com/maps/dir/?api=1&destination="+b+"'><i class='fas fa-map-marked-alt'></i> "+b+"</a><br /><br /><b>\u53e3\u7f69\u5269\u9918\u6578\u91cf</b> (<span class='question_btn link-style' title='\u8cc7\u8a0a\u6709\u8aa4\u55ce\uff1f'>\u8cc7\u8a0a\u6709\u8aa4\u55ce\uff1f</span>)<br />";if(void 0===a)e+="\u7121\u8cc7\u6599<br />";else{reportTime=a[3];reportTime="\u7121\u7d00\u9304";""!=a[2]&&(reportTime=a[2].substr(5).replace(/-/g,
"/")+" ("+calcLastTimeRange(a[2])+")");e=0==a[0]&&0==a[1]?e+"\u7121\u5eab\u5b58":e+("\u6210\u4eba <i class='fas fa-user'></i>\uff1a"+a[0]+"\u3000\u5152\u7ae5 <i class='fas fa-baby'></i>\uff1a"+a[1]);detailData="\u5927\u4eba\u6700\u5f8c\u589e\u52a0\u6642\u9593: "+a[4]+"<br />\u5c0f\u5b69\u6700\u5f8c\u589e\u52a0\u6642\u9593: "+a[6]+"<br />\u5927\u4eba\u6700\u5f8c\u6e1b\u5c11\u6642\u9593: "+a[5]+"<br />\u5c0f\u5b69\u6700\u5f8c\u6e1b\u5c11\u6642\u9593: "+a[7];e+="<br /><span class='moreBusinessInfo' title='"+
detailData+"'>\u6700\u5f8c\u7570\u52d5\u6642\u9593\uff1a"+reportTime+"</span><br />";b=Date.parse(a[3].replace(/-/g,"/"));var g=Date.parse(mask_inventory_last_update.replace(/-/g,"/"));if(0<b-g||""==mask_inventory_last_update)mask_inventory_last_update=a[3]}void 0!=c.business_week&&(a=c.business_week.split(""),e+="<br/><b>\u71df\u696d\u8cc7\u8a0a</b><span class='showBusinessWeek link-style'> (\u9ede\u6211\u986f\u793a\u6216\u96b1\u85cf)</span><br/>",e+="<table id='businessWeek' style='display:none;' class='tg'><tr><th class='tg-lboi'></th><th class='tg-lboi'>\u4e00</th><th class='tg-lboi'>\u4e8c</th><th class='tg-lboi'>\u4e09</th><th class='tg-lboi'>\u56db</th><th class='tg-lboi'>\u4e94</th><th class='tg-lboi'>\u516d</th><th class='tg-lboi'>\u65e5</th></tr><tr><td class='tg-lboi'>\u4e0a</td><td class='tg-lboi'>"+
a[0]+"</td><td class='tg-lboi'>"+a[1]+"</td><td class='tg-lboi'>"+a[2]+"</td><td class='tg-lboi'>"+a[3]+"</td><td class='tg-lboi'>"+a[4]+"</td><td class='tg-weekend'>"+a[5]+"</td><td class='tg-weekend'>"+a[6]+"</td></tr><tr><td class='tg-lboi'>\u4e0b</td><td class='tg-lboi'>"+a[7]+"</td><td class='tg-lboi'>"+a[8]+"</td><td class='tg-lboi'>"+a[9]+"</td><td class='tg-lboi'>"+a[10]+"</td><td class='tg-lboi'>"+a[11]+"</td><td class='tg-weekend'>"+a[12]+"</td><td class='tg-weekend'>"+a[13]+"</td></tr><tr><td class='tg-lboi'>\u665a</td><td class='tg-lboi'>"+
a[14]+"</td><td class='tg-lboi'>"+a[15]+"</td><td class='tg-lboi'>"+a[16]+"</td><td class='tg-lboi'>"+a[17]+"</td><td class='tg-lboi'>"+a[18]+"</td><td class='tg-weekend'>"+a[19]+"</td><td class='tg-weekend'>"+a[20]+"</td></tr></table>");void 0!==c.memo&&(c=$.trim(c.memo),0<c.length&&(e=-1!=c.indexOf("\u53e3\u7f69")?e+("<br/><span class='highred'>\u5099\u8a3b\uff1a"+c+"</span>"):e+("<br/>\u5099\u8a3b\uff1a"+c)));return e},loadMaskInventory=function(c){mask_inventory=[];var e=new Date,b=e.getMinutes();
b=10*(parseInt((b+10)/10)-1)+5;e=(new Date(e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),b)).getTime();$.ajax({url:"data/maskdata_auto.csv",async:c,cache:!1,data:{r:e},dataType:"text",success:function(a){a=a.split("\n");for(var c in a)if({}.hasOwnProperty.call(a,c)){var b=a[c].split(",");""!=$.trim(b[0])&&(mask_inventory[b[0]]=[b[1],b[2],b[3].replace(/"/g,""),b[4].replace(/"/g,""),b[5].replace(/"/g,""),b[6].replace(/"/g,""),b[7].replace(/"/g,""),b[8].replace(/"/g,"")])}createStrongholdData()},
complete:function(a,b){$("#reload_btn i").removeClass();$("#reload_btn i").addClass("fas fa-sync");$("#reload_btn").attr("disabled",!1)}})},createStrongholdData=function(){void 0!==markers&&markers.clearLayers();var c=new Date;c=c.getDay();for(var e in locations)if({}.hasOwnProperty.call(locations,e)){var b=!0,a=locations[e],g="",h=0,k=0;void 0!==mask_inventory[a.id]?(g=mask_inventory[a.id],h=parseInt(g[0]),k=parseInt(g[1]),show_adult_inventory?2>=h&&b&&(b=!1):show_child_inventory&&2>=k&&b&&(b=!1),
g=0<h+k?"<i class='fas fa-user'></i>"+h+"&nbsp;<i class='fas fa-baby'></i>"+k:"\u7121\u5eab\u5b58"):g="\u7121\u5eab\u5b58";"\u7121\u5eab\u5b58"==g&&!1===show_inventory_zero&&b&&(b=!1);if(dont_show_no_open&&void 0!==a.business_week){var d=a.business_week.split("");if(1==c&&b){b=!("X"==d[0]&&"X"==d[7]&&"X"==d[14]);var l=d[0];var m=d[7];var n=d[14]}else 2==c&&b?(b=!("X"==d[1]&&"X"==d[8]&&"X"==d[15]),l=d[1],m=d[8],n=d[15]):3==c&&b?(b=!("X"==d[2]&&"X"==d[9]&&"X"==d[16]),l=d[2],m=d[9],n=d[16]):4==c&&b?
(b=!("X"==d[3]&&"X"==d[10]&&"X"==d[17]),l=d[3],m=d[10],n=d[17]):5==c&&b?(b=!("X"==d[4]&&"X"==d[11]&&"X"==d[18]),l=d[4],m=d[11],n=d[18]):6==c&&b?(b=!("X"==d[5]&&"X"==d[12]&&"X"==d[19]),l=d[5],m=d[12],n=d[19]):0==c&&b&&(b=!("X"==d[6]&&"X"==d[13]&&"X"==d[20]),l=d[6],m=d[13],n=d[20]);b&&(b=checkTimerOpen(l,m,n,b))}var f=h+k,p=400;d="";!1===show_adult_inventory&&!1===show_child_inventory&&(p=800,f=h+k);!0===show_adult_inventory&&!0===show_child_inventory?h>k?(p=200,f=k):(p=600,f=h):show_adult_inventory?
(p=200,f=h):show_child_inventory&&(p=200,f=k);f>=p/2?(d="inventory-hight",show_inventory_hight||(b=!1)):f>=.2*p?(d="inventory-medium",show_inventory_medium||(b=!1)):0<f?(d="inventory-low",show_inventory_low||(b=!1)):0==f&&(d="inventory-zero");b&&(b="",void 0!==a.memo&&(f=$.trim(a.memo),0<f.length&&(-1!=f.indexOf("\u53e3\u7f69")||-1!=f.indexOf("\u865f\u78bc"))&&(b="\u8cfc\u8cb7\u898f\u5247<span class='fas fa-angle-right'></span>")),f=100,h=h.toString().concat(k.toString()).length,"\u7121\u5eab\u5b58"==
g&&""==b?f=52:"\u7121\u5eab\u5b58"==g&&""!=b?f=82:6>h&&""==b?f=68:6>h&&""!=b?f=82:6==h?f=84:7==h?f=92:8==h&&(f=100),g=L.divIcon({popupAnchor:[0,-30],iconAnchor:[f/2,0],iconSize:null,html:'<div class="map-label"><div class="map-label-content '+d+'">'+g+'<div class="map-label-content-more">'+b+'</div></div><div class="map-label-arrow"></div></div>'}),g=L.marker([a.lat,a.lng],{icon:g,title:a.name,alt:a.name}).bindPopup(strongholdInfo(a),{minWidth:210}).openTooltip().on("popupopen",function(a){$(".question_btn").click(function(a){showQuestionInfo()});
$(".moreBusinessInfo").click(function(){var a=$(this).find(".title");a.length?a.remove():$(this).append('<span class="title">'+$(this).attr("title")+"</span>")});$(".showBusinessWeek").click(function(a){$("#businessWeek").toggle(500)});gtag("event","click",{event_category:"\u8ca9\u552e\u64da\u9ede",event_label:a.popup._source.pid})}),g.pid=a.id+a.name,markers.addLayer(g))}omap.addLayer(markers);$("#mask_inventory_last_update").text(mask_inventory_last_update.substr(5).replace(/-/g,"/"))},calcLastTimeRange=
function(c){c=new Date(c.replace(/-/g,"/"));var e=(new Date).getTime()-c.getTime();c=Math.floor(e/864E5);var b=e%864E5;e=Math.floor(b/36E5);b=Math.floor(b%36E5/6E4);var a="";0!=c?a='<span class="highred" >'+c+"\u5929\u524d</span>":0==c&&0!=e?a='<span class="highred" >'+e+"\u5c0f\u6642\u524d</span>":0==c&&0==e&&40<=b?a='<span class="highred" >'+b+"\u5206\u937e\u524d</span>":0==c&&0==e&&(a=b+"\u5206\u937e\u524d");return a};