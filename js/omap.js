var omap,marker_user,markers,default_lat=25.0315785,default_lng=121.4427123,mask_inventory=[],show_adult_inventory=!1,show_child_inventory=!1,dont_show_null_inventory=!0,dont_show_no_open=!0,mask_inventory_last_update="",show_inventory_hight=!0,show_inventory_medium=!0,show_inventory_low=!0,show_inventory_zero=!1;$(function(){getUserGEOInfo(!1)});
var geoSuccess=function(b){b=b.coords;default_lat=b.latitude;default_lng=b.longitude;void 0!==marker_user?marker_user.setLatLng([default_lat,default_lng]):(void 0===omap&&createMap(),marker_user=L.marker([default_lat,default_lng]).bindTooltip("\u6211",{direction:"top",permanent:!0}).openTooltip(),marker_user.addTo(omap));omap.setView([default_lat,default_lng],16)},geoError=function(b){void 0===omap&&createMap()},getUserGEOInfo=function(b){!0===b&&gtag("event","click",{event_category:"\u5730\u5716\u5de5\u5177",
event_label:"\u4f7f\u7528\u8005\u5b9a\u4f4d"});navigator.geolocation?navigator.geolocation.getCurrentPosition(geoSuccess,geoError,{enableHighAccuracy:!0,timeout:5E3,maximumAge:0}):void 0===omap&&createMap()},onMapLoad=function(){showTopMessage()},createMap=function(){omap=L.map("omap",{zoomControl:!1});omap.on("load",onMapLoad);omap.setView([default_lat,default_lng],16);L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://maps.nlsc.gov.tw/">\u570b\u571f\u6e2c\u7e6a\u4e2d\u5fc3</a>',
maxZoom:20,minZoom:9}).addTo(omap);L.control.zoom({position:"bottomright"}).addTo(omap);createCustomButton();markers=L.markerClusterGroup({chunkedLoading:!0,disableClusteringAtZoom:16,elementsPlacementStrategy:"original-locations"});loadMaskInventory(!1)},createCustomButton=function(){L.control.custom({position:"bottomright",content:'<button id="back_btn" type="button" class="btn btn-default" title="\u56de\u5230\u6211\u7684\u4f4d\u7f6e">    <i class="fas fa-crosshairs"></i></button><button id="exclamation_btn" type="button" class="btn btn-danger" title="\u91cd\u8981">    <i class="fas fa-exclamation-triangle"></i></button><button id="info_btn" type="button" class="btn btn-info" title="\u516c\u544a">    <i class="fas fa-info"></i></button><button id="reload_btn" type="button" class="btn btn-primary" title="\u91cd\u65b0\u6574\u7406">    <i class="fas fa-sync"></i></button><button id="history_btn" type="button" class="btn btn-success" title="\u66f4\u65b0\u7d00\u9304">    <i class="fas fa-list-alt"></i></button><button id="twcdc_fb_btn" type="button" class="btn btn-warning" title="\u75be\u7ba1\u7f72">    <i class="fas fa-clinic-medical"></i></button>',
classes:"btn-group-vertical bt-group-sm",style:{margin:"10px",padding:"0px 0 0 0",cursor:"pointer"}}).addTo(omap);$("#back_btn").click(function(b){getUserGEOInfo(!0)});$("#exclamation_btn").click(function(b){showWarningMessage()});$("#info_btn").click(function(b){showInfoMessage()});$("#reload_btn").click(function(b){showUpdateProcess()});$("#history_btn").click(function(b){showVersionHistory()});$("#twcdc_fb_btn").click(function(b){showTwcdcFB()})},reloadStrongholdData=function(b){$("#reload_btn").attr("disabled",
!0);$("#reload_btn i").removeClass();$("#reload_btn i").addClass("fas fa-sync fa-spin fa-fw");$("#mask_inventory_last_update").html('<span id="process_status" class="fa fa-spinner fa-spin"></span>');loadMaskInventory(b)},checkTimerOpen=function(b,e,a,d){b=(new Date).getHours();return 13<=b&&"X"==e&&"X"==a?!1:18<=b&&"X"==a?!1:d},strongholdInfo=function(b){var e=b.tel,a=b.addr,d=mask_inventory[b.id];e="<h3>"+b.name+"</h3>\u96fb\u8a71\uff1a<a href='tel:+886"+(e+"'><i class='fas fa-phone-alt'></i> "+
e+"</a><br />");e+="\u5730\u5740\uff1a<a target='_blank' href='https://www.google.com/maps/dir/?api=1&destination="+a+"'><i class='fas fa-map-marked-alt'></i> "+a+"</a><br /><br /><b>\u53e3\u7f69\u5269\u9918\u6578\u91cf</b> (<span class='question_btn link-style' title='\u8cc7\u8a0a\u6709\u8aa4\u55ce\uff1f'>\u8cc7\u8a0a\u6709\u8aa4\u55ce\uff1f</span>)<br />";void 0===d?e+="\u7121\u8cc7\u6599<br />":(reportTime=d[3],reportTime="\u7121\u7d00\u9304",""!=d[2]&&(reportTime=d[2].substr(5).replace(/-/g,"/")+
" ("+calcLastTimeRange(d[2])+")"),e=0==d[0]&&0==d[1]?e+"\u7121\u5eab\u5b58":e+("\u6210\u4eba <i class='fas fa-user'></i>\uff1a"+d[0]+"\u3000\u5152\u7ae5 <i class='fas fa-baby'></i>\uff1a"+d[1]),detailData="\u5927\u4eba\u6700\u5f8c\u589e\u52a0\u6642\u9593: "+d[4]+"<br />\u5c0f\u5b69\u6700\u5f8c\u589e\u52a0\u6642\u9593: "+d[6]+"<br />\u5927\u4eba\u6700\u5f8c\u6e1b\u5c11\u6642\u9593: "+d[5]+"<br />\u5c0f\u5b69\u6700\u5f8c\u6e1b\u5c11\u6642\u9593: "+d[7],e+="<br /><span class='moreBusinessInfo' title='"+
detailData+"'>\u6700\u5f8c\u56de\u5831\u6642\u9593\uff1a"+reportTime+"</span><br />",mask_inventory_last_update=d[3].substr(5).replace(/-/g,"/"));void 0!=b.business_week&&(a=b.business_week.split(""),e+="<br/><b>\u71df\u696d\u8cc7\u8a0a</b><span class='showBusinessWeek link-style'> (\u9ede\u6211\u986f\u793a\u6216\u96b1\u85cf)</span><br/>",e+="<table id='businessWeek' style='display:none;' class='tg'><tr><th class='tg-lboi'></th><th class='tg-lboi'>\u4e00</th><th class='tg-lboi'>\u4e8c</th><th class='tg-lboi'>\u4e09</th><th class='tg-lboi'>\u56db</th><th class='tg-lboi'>\u4e94</th><th class='tg-lboi'>\u516d</th><th class='tg-lboi'>\u65e5</th></tr><tr><td class='tg-lboi'>\u4e0a</td><td class='tg-lboi'>"+
a[0]+"</td><td class='tg-lboi'>"+a[1]+"</td><td class='tg-lboi'>"+a[2]+"</td><td class='tg-lboi'>"+a[3]+"</td><td class='tg-lboi'>"+a[4]+"</td><td class='tg-weekend'>"+a[5]+"</td><td class='tg-weekend'>"+a[6]+"</td></tr><tr><td class='tg-lboi'>\u4e0b</td><td class='tg-lboi'>"+a[7]+"</td><td class='tg-lboi'>"+a[8]+"</td><td class='tg-lboi'>"+a[9]+"</td><td class='tg-lboi'>"+a[10]+"</td><td class='tg-lboi'>"+a[11]+"</td><td class='tg-weekend'>"+a[12]+"</td><td class='tg-weekend'>"+a[13]+"</td></tr><tr><td class='tg-lboi'>\u665a</td><td class='tg-lboi'>"+
a[14]+"</td><td class='tg-lboi'>"+a[15]+"</td><td class='tg-lboi'>"+a[16]+"</td><td class='tg-lboi'>"+a[17]+"</td><td class='tg-lboi'>"+a[18]+"</td><td class='tg-weekend'>"+a[19]+"</td><td class='tg-weekend'>"+a[20]+"</td></tr></table>");void 0!==b.memo&&(b=$.trim(b.memo),0<b.length&&(e=-1!=b.indexOf("\u53e3\u7f69")?e+("<br/><span id='highred'>\u5099\u8a3b\uff1a"+b+"</span>"):e+("<br/>\u5099\u8a3b\uff1a"+b)));return e},loadMaskInventory=function(b){mask_inventory=[];var e=new Date,a=e.getMinutes();
a=10*(parseInt((a+10)/10)-1)+5;e=(new Date(e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),a)).getTime();$.ajax({url:"data/maskdata_auto.csv",async:b,cache:!1,data:{r:e},dataType:"text",success:function(a){a=a.split("\n");for(var b in a)if({}.hasOwnProperty.call(a,b)){var d=a[b].split(",");""!=$.trim(d[0])&&(mask_inventory[d[0]]=[d[1],d[2],d[3].replace(/"/g,""),d[4].replace(/"/g,""),d[5].replace(/"/g,""),d[6].replace(/"/g,""),d[7].replace(/"/g,""),d[8].replace(/"/g,"")])}createStrongholdData()},
complete:function(a,b){$("#reload_btn i").removeClass();$("#reload_btn i").addClass("fas fa-sync");$("#reload_btn").attr("disabled",!1)}})},createStrongholdData=function(){void 0!==markers&&markers.clearLayers();var b=new Date;b=b.getDay();for(var e in locations)if({}.hasOwnProperty.call(locations,e)){var a=!0,d=locations[e],h="",g=0,k=0;void 0!==mask_inventory[d.id]?(h=mask_inventory[d.id],g=parseInt(h[0]),k=parseInt(h[1]),show_adult_inventory?2>=g&&a&&(a=!1):show_child_inventory&&2>=k&&a&&(a=!1),
h=0<g+k?"<i class='fas fa-user'></i>"+g+"&nbsp;<i class='fas fa-baby'></i>"+k:"\u7121\u5eab\u5b58"):h="\u7121\u5eab\u5b58";"\u7121\u5eab\u5b58"==h&&!1===show_inventory_zero&&a&&(a=!1);if(dont_show_no_open&&void 0!==d.business_week){var c=d.business_week.split("");if(1==b&&a){a=!("X"==c[0]&&"X"==c[7]&&"X"==c[14]);var l=c[0];var m=c[7];var n=c[14]}else 2==b&&a?(a=!("X"==c[1]&&"X"==c[8]&&"X"==c[15]),l=c[1],m=c[8],n=c[15]):3==b&&a?(a=!("X"==c[2]&&"X"==c[9]&&"X"==c[16]),l=c[2],m=c[9],n=c[16]):4==b&&a?
(a=!("X"==c[3]&&"X"==c[10]&&"X"==c[17]),l=c[3],m=c[10],n=c[17]):5==b&&a?(a=!("X"==c[4]&&"X"==c[11]&&"X"==c[18]),l=c[4],m=c[11],n=c[18]):6==b&&a?(a=!("X"==c[5]&&"X"==c[12]&&"X"==c[19]),l=c[5],m=c[12],n=c[19]):0==b&&a&&(a=!("X"==c[6]&&"X"==c[13]&&"X"==c[20]),l=c[6],m=c[13],n=c[20]);a&&(a=checkTimerOpen(l,m,n,a))}var f=g+k,p=400;c="";!1===show_adult_inventory&&!1===show_child_inventory&&(p=800,f=g+k);!0===show_adult_inventory&&!0===show_child_inventory?g>k?(p=200,f=k):(p=600,f=g):show_adult_inventory?
(p=200,f=g):show_child_inventory&&(p=200,f=k);f>=p/2?(c="inventory-hight",show_inventory_hight||(a=!1)):f>=.2*p?(c="inventory-medium",show_inventory_medium||(a=!1)):0<f?(c="inventory-low",show_inventory_low||(a=!1)):0==f&&(c="inventory-zero");a&&(a="",void 0!==d.memo&&(f=$.trim(d.memo),0<f.length&&(-1!=f.indexOf("\u53e3\u7f69")||-1!=f.indexOf("\u865f\u78bc"))&&(a="\u8cfc\u8cb7\u898f\u5247<span class='fas fa-angle-right'></span>")),f=100,g=g.toString().concat(k.toString()).length,"\u7121\u5eab\u5b58"==
h&&""==a?f=52:"\u7121\u5eab\u5b58"==h&&""!=a?f=82:6>g&&""==a?f=68:6>g&&""!=a?f=82:6==g?f=84:7==g?f=92:8==g&&(f=100),h=L.divIcon({popupAnchor:[0,-30],iconAnchor:[f/2,0],iconSize:null,html:'<div class="map-label"><div class="map-label-content '+c+'">'+h+'<div class="map-label-content-more">'+a+'</div></div><div class="map-label-arrow"></div></div>'}),h=L.marker([d.lat,d.lng],{icon:h,title:d.name,alt:d.name}).bindPopup(strongholdInfo(d),{minWidth:210}).openTooltip().on("popupopen",function(a){$(".question_btn").click(function(a){showQuestionInfo()});
$(".moreBusinessInfo").click(function(){var a=$(this).find(".title");a.length?a.remove():$(this).append('<span class="title">'+$(this).attr("title")+"</span>")});$(".showBusinessWeek").click(function(a){$("#businessWeek").toggle(500)});gtag("event","click",{event_category:"\u8ca9\u552e\u64da\u9ede",event_label:a.popup._source.pid})}),h.pid=d.id+d.name,markers.addLayer(h))}omap.addLayer(markers);$("#mask_inventory_last_update").text(mask_inventory_last_update.replace("2020/",""))},calcLastTimeRange=
function(b){b=new Date(b.replace(/-/g,"/"));var e=(new Date).getTime()-b.getTime();b=Math.floor(e/864E5);var a=e%864E5;e=Math.floor(a/36E5);a=Math.floor(a%36E5/6E4);var d="";0!=b?d=b+"\u5929\u524d":0==b&&0!=e?d=e+"\u5c0f\u6642\u524d":0==b&&0==e&&(d=a+"\u5206\u937e\u524d");return d};