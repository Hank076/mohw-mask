;var omap;var marker_user;var markers;var default_lat=25.0315785;var default_lng=121.4427123;var mask_inventory=[];var show_adult_inventory=false;var show_child_inventory=false;var dont_show_null_inventory=true;var dont_show_no_open=true;var mask_inventory_last_update='';var show_inventory_hight=true;var show_inventory_medium=true;var show_inventory_low=true;var show_inventory_zero=false;$(function(){getUserGEOInfo(false)});var geoSuccess=function(a){var b=a.coords;default_lat=b.latitude;default_lng=b.longitude;if(marker_user!==undefined){marker_user.setLatLng([default_lat,default_lng])}else{if(omap===undefined){createMap()}marker_user=L.marker([default_lat,default_lng]).bindTooltip("我",{direction:"top",permanent:true}).openTooltip();marker_user.addTo(omap)}omap.setView([default_lat,default_lng],16)};var geoError=function(a){if(omap===undefined){createMap()}};var getUserGEOInfo=function(a){if(a===true){gtag('event','click',{'event_category':'地圖工具','event_label':'使用者定位'})}if(navigator.geolocation){var b={enableHighAccuracy:true,timeout:5000,maximumAge:0};navigator.geolocation.getCurrentPosition(geoSuccess,geoError,b)}else{if(omap===undefined){createMap()}}};var onMapLoad=function(){showTopMessage()};var createMap=function(){omap=L.map('omap',{zoomControl:false});omap.on('load',onMapLoad);omap.setView([default_lat,default_lng],16);var a=L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://maps.nlsc.gov.tw/">國土測繪中心</a>',maxZoom:20,minZoom:9}).addTo(omap);L.control.zoom({position:'bottomright'}).addTo(omap);createCustomButton();markers=L.markerClusterGroup({chunkedLoading:true,disableClusteringAtZoom:16,elementsPlacementStrategy:'original-locations'});loadMaskInventory(false)};var createCustomButton=function(){L.control.custom({position:'bottomright',content:'<button id="back_btn" type="button" class="btn btn-default" title="回到我的位置">'+'    <i class="fas fa-crosshairs"></i>'+'</button>'+'<button id="exclamation_btn" type="button" class="btn btn-danger" title="重要">'+'    <i class="fas fa-exclamation-triangle"></i>'+'</button>'+'<button id="info_btn" type="button" class="btn btn-info" title="公告">'+'    <i class="fas fa-info"></i>'+'</button>'+'<button id="reload_btn" type="button" class="btn btn-primary" title="重新整理">'+'    <i class="fas fa-sync"></i>'+'</button>'+'<button id="history_btn" type="button" class="btn btn-success" title="更新紀錄">'+'    <i class="fas fa-list-alt"></i>'+'</button>'+'<button id="twcdc_fb_btn" type="button" class="btn btn-warning" title="疾管署">'+'    <i class="fas fa-clinic-medical"></i>'+'</button>',classes:'btn-group-vertical bt-group-sm',style:{margin:'10px',padding:'0px 0 0 0',cursor:'pointer',}}).addTo(omap);$("#back_btn").click(function(a){getUserGEOInfo(true)});$("#exclamation_btn").click(function(a){showWarningMessage()});$("#info_btn").click(function(a){showInfoMessage()});$("#reload_btn").click(function(a){showUpdateProcess()});$("#history_btn").click(function(a){showVersionHistory()});$("#twcdc_fb_btn").click(function(a){showTwcdcFB()})};var reloadStrongholdData=function(a){loadMaskInventory(a)};var checkTimerOpen=function(a,b,c,d){var e=new Date();var f=e.getHours();if(f>=13&&b=='X'&&c=='X'){return false}else if(f>=18&&c=='X'){return false}else{return d}};var strongholdInfo=function(a){var b=a.name;var c=a.tel;var d=a.addr;var e=mask_inventory[a.id];var f="<h3>"+b+"</h3>";f+="電話：<a href='tel:+886"+c+"'><i class='fas fa-phone-alt'></i> "+c+"</a><br />";f+="地址：<a target='_blank' href='https://www.google.com/maps/dir/?api=1&destination="+d+"'><i class='fas fa-map-marked-alt'></i> "+d+"</a><br />";f+="<br /><b>口罩剩餘數量</b> (<span class='question_btn link-style' title='資訊有誤嗎？'>資訊有誤嗎？</span>)<br />";if(e===undefined){f+="無資料"+"<br />"}else{reportTime=e[3];reportTime='無紀錄';if(e[2]!=''){reportTime=e[2].substr(5).replace(/-/g,"/")+' ('+calcLastTimeRange(e[2])+')'}if(e[0]==0&&e[1]==0){f+="無庫存"}else{f+="成人 <i class='fas fa-user'></i>："+e[0]+"　兒童 <i class='fas fa-baby'></i>："+e[1]}detailData="大人最後增加時間: "+e[4]+"<br />小孩最後增加時間: "+e[6]+"<br />大人最後減少時間: "+e[5]+"<br />小孩最後減少時間: "+e[7];f+="<br /><span class='moreBusinessInfo' title='"+detailData+"'>最後回報時間："+reportTime+"</span><br />";mask_inventory_last_update=e[3].substr(5).replace(/-/g,"/")}if(a.business_week!=undefined){var g=a.business_week.split('');f+="<br/><b>營業資訊</b><span class='showBusinessWeek link-style'> (點我顯示或隱藏)</span><br/>";f+="<table id='businessWeek' style='display:none;' class='tg'><tr><th class='tg-lboi'></th><th class='tg-lboi'>一</th><th class='tg-lboi'>二</th><th class='tg-lboi'>三</th><th class='tg-lboi'>四</th><th class='tg-lboi'>五</th><th class='tg-lboi'>六</th><th class='tg-lboi'>日</th></tr><tr><td class='tg-lboi'>上</td><td class='tg-lboi'>"+g[0]+"</td><td class='tg-lboi'>"+g[1]+"</td><td class='tg-lboi'>"+g[2]+"</td><td class='tg-lboi'>"+g[3]+"</td><td class='tg-lboi'>"+g[4]+"</td><td class='tg-weekend'>"+g[5]+"</td><td class='tg-weekend'>"+g[6]+"</td></tr><tr><td class='tg-lboi'>下</td><td class='tg-lboi'>"+g[7]+"</td><td class='tg-lboi'>"+g[8]+"</td><td class='tg-lboi'>"+g[9]+"</td><td class='tg-lboi'>"+g[10]+"</td><td class='tg-lboi'>"+g[11]+"</td><td class='tg-weekend'>"+g[12]+"</td><td class='tg-weekend'>"+g[13]+"</td></tr><tr><td class='tg-lboi'>晚</td><td class='tg-lboi'>"+g[14]+"</td><td class='tg-lboi'>"+g[15]+"</td><td class='tg-lboi'>"+g[16]+"</td><td class='tg-lboi'>"+g[17]+"</td><td class='tg-lboi'>"+g[18]+"</td><td class='tg-weekend'>"+g[19]+"</td><td class='tg-weekend'>"+g[20]+"</td></tr></table>"}if(a.memo!==undefined){var h=$.trim(a.memo);if(h.length>0){if(h.indexOf('口罩')!=-1){f+="<br/><span id='highred'>備註："+h+'</span>'}else{f+="<br/>備註："+h}}}return f};var loadMaskInventory=function(d){mask_inventory=[];var e=new Date();var f=e.getMinutes();f=((parseInt((f+10)/10)-1)*10)+5;var g=new Date(e.getFullYear(),(e.getMonth()+1),e.getDate(),e.getHours(),f);var h=g.getTime();$.ajax({url:"data/maskdata_auto.csv",async:d,cache:false,data:{r:h},dataType:"text",success:function(a){var b=a.split("\n");for(var i in b){if({}.hasOwnProperty.call(b,i)){var c=b[i].split(",");if($.trim(c[0])!=''){mask_inventory[c[0]]=[c[1],c[2],c[3].replace(/\"/g,''),c[4].replace(/\"/g,''),c[5].replace(/\"/g,''),c[6].replace(/\"/g,''),c[7].replace(/\"/g,''),c[8].replace(/\"/g,'')]}}}createStrongholdData()}})};var createStrongholdData=function(){if(markers!==undefined){markers.clearLayers()}var c=new Date();c=c.getDay();for(var d in locations){if({}.hasOwnProperty.call(locations,d)){var e=true;var f=locations[d];var g="";var h=0;var i=0;if(mask_inventory[f.id]!==undefined){g=mask_inventory[f.id];h=parseInt(g[0]);i=parseInt(g[1]);if(show_adult_inventory){if(h<=2&&e){e=false}}else if(show_child_inventory){if(i<=2&&e){e=false}}var j=h+i;if(j>0){g="<i class='fas fa-user'></i>"+h+"&nbsp;<i class='fas fa-baby'></i>"+i}else{g="無庫存"}}else{g="無庫存"}if(g=="無庫存"){if(show_inventory_zero===false&&e){e=false}}if(dont_show_no_open&&f.business_week!==undefined){var k,t2,t3;var l=f.business_week.split('');if(c==1&&e){e=!(l[0]=='X'&&l[7]=='X'&&l[14]=='X');k=l[0];t2=l[7];t3=l[14]}else if(c==2&&e){e=!(l[1]=='X'&&l[8]=='X'&&l[15]=='X');k=l[1];t2=l[8];t3=l[15]}else if(c==3&&e){e=!(l[2]=='X'&&l[9]=='X'&&l[16]=='X');k=l[2];t2=l[9];t3=l[16]}else if(c==4&&e){e=!(l[3]=='X'&&l[10]=='X'&&l[17]=='X');k=l[3];t2=l[10];t3=l[17]}else if(c==5&&e){e=!(l[4]=='X'&&l[11]=='X'&&l[18]=='X');k=l[4];t2=l[11];t3=l[18]}else if(c==6&&e){e=!(l[5]=='X'&&l[12]=='X'&&l[19]=='X');k=l[5];t2=l[12];t3=l[19]}else if(c==0&&e){e=!(l[6]=='X'&&l[13]=='X'&&l[20]=='X');k=l[6];t2=l[13];t3=l[20]}if(e){e=checkTimerOpen(k,t2,t3,e)}}var m=h+i;var n=600;var o=200;var p=(n+o)/2;var q='';if(show_adult_inventory===false&&show_child_inventory===false){p=n+o;m=h+i}if(show_adult_inventory===true&&show_child_inventory===true){if(h>i){p=o;m=i}else{p=n;m=h}}else if(show_adult_inventory){p=o;m=h}else if(show_child_inventory){p=o;m=i}if(m>=(p/2)){q='inventory-hight';if(!show_inventory_hight){e=false}}else if(m>=(p*0.2)){q='inventory-medium';if(!show_inventory_medium){e=false}}else if(m>0){q='inventory-low';if(!show_inventory_low){e=false}}else if(m==0){q='inventory-zero'}if(e){var r='';if(f.memo!==undefined){var s=$.trim(f.memo);if(s.length>0){if(s.indexOf('口罩')!=-1||s.indexOf('號碼')!=-1){r="購買規則▶"}}}var t=100;var u=h.toString().concat(i.toString()).length;if(g=="無庫存"&&r==''){t=52}else if(g=="無庫存"&&r!=''){t=82}else if(u<6&&r==''){t=68}else if(u<6&&r!=''){t=82}else if(u==6){t=84}else if(u==7){t=92}else if(u==8){t=100}var v=L.divIcon({popupAnchor:[0,-30],iconAnchor:[(t/2),0],iconSize:null,html:'<div class="map-label"><div class="map-label-content '+q+'">'+g+'<div class="map-label-content-more">'+r+'</div></div><div class="map-label-arrow"></div></div>'});var w=L.marker([f.lat,f.lng],{icon:v,title:f.name,alt:f.name}).bindPopup(strongholdInfo(f),{minWidth:210}).openTooltip().on('popupopen',function(b){$(".question_btn").click(function(a){showQuestionInfo()});$(".moreBusinessInfo").click(function(){var a=$(this).find(".title");if(!a.length){$(this).append('<span class="title">'+$(this).attr("title")+'</span>')}else{a.remove()}});$(".showBusinessWeek").click(function(a){$('#businessWeek').toggle(500)});gtag('event','click',{'event_category':'販售據點','event_label':b.popup._source.pid})});w.pid=f.id+f.name;markers.addLayer(w)}}}omap.addLayer(markers);$('#mask_inventory_last_update').text(' (更新時間：'+mask_inventory_last_update.replace("2020/","")+')')};var calcLastTimeRange=function(a){var b=new Date(a.replace(/-/g,"/"));var c=new Date();var d=c.getTime()-b.getTime();var e=Math.floor(d/(24*3600*1000));var f=d%(24*3600*1000);var g=Math.floor(f/(3600*1000));var h=f%(3600*1000);var i=Math.floor(h/(60*1000));var j=h%(60*1000);var k=Math.round(j/1000);var l='';if(e!=0){l=e+'天前'}else if(e==0&&g!=0){l=g+'小時前'}else if(e==0&&g==0){l=i+'分鍾前'}return l};;